<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>

<!--/* /layout/header.html의 headFrag조각으로 head 태그를 바꾼다. */-->
<head th:replace="~{/layout/header::headFrag('Welcome')}"></head>
  <div th:replace="~{/layout/header::gnbFrag}"></div>
  
<style>
table {
    border-collapse: collapse;
    width: 90%;
    margin-left: 20px;
        margin-top: 30px;
  }
table img {
  height: 100px;
}

.imgTd {
  width: 215px;
}  

/* 배치 */
th, td {
   padding: 8px;
   text-align: left;
   border-bottom: 1px solid #ddd;
}

th {
   background-color: #8FA691; 
   color: white;
    height: 40px;
   text-align: left;
}


#myform fieldset{
    display: inline-block;
    direction: rtl;
    border:0;
}
#myform fieldset legend{
    text-align: right;
}
#myform input[type=radio]{
    display: none;
}
#myform label{
    font-size: 3em;
    color: transparent;
    text-shadow: 0 0 0 #f0f0f0;
}
#myform label:hover{
    text-shadow: 0 0 0 rgba(250, 208, 0, 0.99);
}
#myform label:hover ~ label{
    text-shadow: 0 0 0 rgba(250, 208, 0, 0.99);
}
#myform input[type=radio]:checked ~ label{
    text-shadow: 0 0 0 rgba(250, 208, 0, 0.99);
}
#reviewContents {
    width: 100%;
    height: 150px;
    padding: 10px;
    box-sizing: border-box;
    border: solid 1.5px #D3D3D3;
    border-radius: 5px;
    font-size: 16px;
    resize: none;
}

</style>  
  <body> 
    <section class="ftco-section ftco-cart">
     <div class="container">
      <div class="regi_main">
        <div class="mainContent">
              <div class="title">
                  <h3>구독 이용 정보</h3>
             </div>
             
              <form id="frm1" method="get" action="/regular/regularMyOrder.html">
                <input type="hidden" name="regPayStatus" value="1">
              </form>
              <form id="frm2" method="get" action="/regular/regularMyOrder.html">
                <input type="hidden" name="cancel" value="1">
              </form>
              <form id="frm3" method="get" action="/regular/regularMyOrder.html">
                <input type="hidden" name="regPayStatus" value="2">
              </form>
              <form id="frm4" method="get" action="/regular/regularMyOrder.html">
              </form>
             <div>
              <input type="button" value="구독조회" onclick="$('#frm1').submit()">
              <input type="button" value="구독취소예약조회" onclick="$('#frm2').submit()">
              <input type="button" value="구독취소조회" onclick="$('#frm3').submit()">
              <input type="button" value="전체조회" onclick="$('#frm4').submit()">
             </div>
             <form id="regOrder" method="post">
               <table aria-setsize="500px">
                  <tbody id="myPerchaseTable">       
                    <th:block th:each="list,vs:${orderList}">     
                       <tr>
                         <td colspan="5">
                         <label>주문일시:&nbsp;</label><span th:text="${#dates.format(list.regPurchaseAt, 'yyyy년 MM월 dd일 E요일 HH:mm')}"></span>
                         &emsp;
                         <label>주문번호:&nbsp;</label><span th:id="'regPurchaseNo' + ${vs.index}" th:text="${list.regPurchaseNo}"></span></td> 
                       </tr>
                       <tr>                         
                         <td class="imgTd" rowspan="3"><a th:href="@{/regular/regularPayDetail.html(regPurchaseNo=${list.regPurchaseNo})}"><img th:src="@{/regular/regularMainDisplay.do(regularNo=${list.regularProductDTO.regularNo})}"></a></td>
                         <td><label>총 구독가격:&nbsp;</label><span th:text="${#numbers.formatInteger(list.regPurchaseLastPrice, 3, 'COMMA') } + 원"></span></td> 
                         <td rowspan="3" style="text-align: center">배송요청일<br><span th:text="${list.regDeliveryDay}"></span><br></td>
                         <th:block th:if="${list.regCancel == 1} and ${list.regPayStatus == 1}">
                           <td rowspan="3" style="text-align: center"><label>구독취소예정일</label><br><span th:text="${#dates.format(oneMonth[vs.index], 'yyyy년 MM월 dd일 E요일')}"></span><br></td>
                           <td rowspan="3" style="text-align: center"><label>구독 종료</label><br><br>
                            <input type="button" th:onclick="|fnRegAgain($('#regPurchaseNo' + ${vs.index}).text())|" value="재구독">
                            <input type="hidden" name="regPurchaseNo">
                           </td>
                         </th:block>  
                         <th:block th:if="${list.regPayStatus == 1} and ${list.regCancel != 1}">
                           <td rowspan="3" style="text-align: center"><label>다음결제일</label><br><span th:text="${#dates.format(oneMonth[vs.index], 'yyyy년 MM월 dd일 E요일')}"></span><br></td>
                           <td rowspan="3" style="text-align: center"><label>구독중</label><br><br>
                            <input type="button" th:onclick="|fnRegCancel($('#regPurchaseNo' + ${vs.index}).text())|" value="구독 취소">
                            <input type="hidden" name="regPurchaseNo">
                           </td>
                         </th:block>  
                         <th:block th:if="${list.regPayStatus == 2}">
                           <td rowspan="3" style="text-align: center"><label></label><br><br></td>
                           <td rowspan="3" style="text-align: center"><label>구독 종료</label><br><br>
                           </td>
                         </th:block> 
                         <td rowspan="3"></td> 
                         <td th:id="'reviewButton' + ${vs.index}" rowspan="3">리뷰작성</td>
                       </tr>  
                       <tr>
                         <td><label>구독상품명:&nbsp;</label><span th:text="| ${list.regularProductDTO.regularName}|"></span></td>    
                       </tr>
                       <tr>
                         <td><label>인원:&nbsp;</label><span th:text="| ${list.regProductCount} 명|"></span></td>
                       </tr>    
                    </th:block>      
                  </tbody>
               </table>
             </form>
          </div>
      </div>
     </div>
     
  <form class="mb-3" name="myform" id="myform" method="post">
    <fieldset>
      <span class="text-bold">별점을 선택해주세요</span>
      <input type="radio" name="reviewStar" value="5" id="rate1"><label
        for="rate1">★</label>
      <input type="radio" name="reviewStar" value="4" id="rate2"><label
        for="rate2">★</label>
      <input type="radio" name="reviewStar" value="3" id="rate3"><label
        for="rate3">★</label>
      <input type="radio" name="reviewStar" value="2" id="rate4"><label
        for="rate4">★</label>
      <input type="radio" name="reviewStar" value="1" id="rate5"><label
        for="rate5">★</label>
    </fieldset>
    <div>
      <textarea class="col-auto form-control" type="text" id="reviewContents"
            placeholder="좋은 수강평을 남겨주시면 Cocolo에 큰 힘이 됩니다! 포인트 5000p도 지급!!"></textarea>
    </div>
  </form>   
    </section>
    <div class="d-flex justify-content-center" th:utext="${pagination}"></div>
  </body>
  <script>
    $(document).ready(function(){
        // 페이지가 로드될 때 모든 주문에 대해 Ajax 요청을 실행합니다.
        $('span[id^="regPurchaseNo"]').each(function(index){
            var purchaseNo = $(this).text();
            $.ajax({
                url: '/regular/checkReview.do',  // 리뷰 존재 여부를 확인하는 서버 엔드포인트
                type: 'post',
                data: {
                    'regPurchaseNo': purchaseNo
                },
                dataType: 'json',
                success: function(resData) {
                    if (resData.check) {  // 리뷰가 이미 존재하는 경우
                        $('#reviewButton' + index).html(
                            '<input type="button" value="리뷰 수정" onclick="fnUpdateReview(\'' + purchaseNo + '\')">' +
                            '<input type="button" value="리뷰 삭제" onclick="fnDeleteReview(\'' + purchaseNo + '\')">'
                        );
                    } else {  // 리뷰가 존재하지 않는 경우
                        $('#reviewButton' + index).html(
                            '<input type="button" value="리뷰 작성" onclick="fnWriteReview(\'' + purchaseNo + '\')">'
                        );
                    }
                },
            });
        });
    });
  
  
    function fnRegCancel(purchaseNo) {
    if(confirm("구독취소를 하시겠습니까?")){
        $('#regOrder').find('input[name="regPurchaseNo"]').val(purchaseNo);
        $('#regOrder').attr('action', '/regular/regCancel.do');
        $('#regOrder').submit();
      }
  	}
  
  	function fnRegAgain(purchaseNo) {
  		if(confirm("다시 구독 하시겠습니까? 재구독시 기존 결제정보로 결제 됩니다.")){
    	  $('#regOrder').find('input[name="regPurchaseNo"]').val(purchaseNo);
    	  $('#regOrder').attr('action', '/regular/regAgain.do');
    	  $('#regOrder').submit();
  		}
	}
  </script>

</html>